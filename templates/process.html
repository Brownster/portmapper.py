<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Process Hostnames | Firewall Request Generator</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-image: url('{{ url_for('static', filename='background.png') }}');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .container {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            max-width: 900px;
            width: 100%;
        }
        
        /* Tab Styles */
        .tabs {
            width: 100%;
            margin-bottom: 20px;
        }
        
        .tab-header {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background-color: #f8f9fa;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            transition: all 0.3s ease;
        }
        
        .tab-btn:hover {
            background-color: #e9ecef;
        }
        
        .tab-btn.active {
            background-color: #2980b9;
            color: white;
            border-bottom: 2px solid #2980b9;
        }
        
        .tab-content {
            display: none;
            padding: 15px 0;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Port Mappings Styles */
        .section-description {
            color: #666;
            margin-top: -10px;
            margin-bottom: 20px;
            font-size: 15px;
        }
        
        .tab-content h3 {
            font-size: 22px;
            color: #333;
            margin-top: 5px;
            margin-bottom: 10px;
        }
        
        .custom-exporter-form {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 4px solid #27ae60;
        }
        
        .custom-exporter-form h4 {
            margin-top: 0;
            color: #444;
            font-size: 16px;
        }
        
        .add-exporter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            align-items: start;
        }
        
        .exporter-field {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }
        
        .exporter-field label {
            font-size: 14px;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        
        .exporter-field input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            height: 35px;
            box-sizing: border-box;
        }
        
        .exporter-field input:focus {
            border-color: #2980b9;
            outline: none;
        }
        
        .exporter-field small {
            font-size: 11px;
            color: #777;
            margin-top: 3px;
            display: block;
            width: 100%;
            text-align: left;
        }
        
        .exporter-field:last-child {
            display: flex;
            align-items: flex-end;
            justify-content: flex-end;
        }
        
        .btn-add {
            background-color: #27ae60;
            color: white;
            padding: 0 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            height: 35px;
            line-height: 35px;
            font-weight: 500;
            font-size: 14px;
            width: 100%;
            text-align: center;
        }
        
        .btn-add:hover {
            background-color: #2ecc71;
        }
        
        .port-mappings-container {
            margin-bottom: 25px;
        }
        
        .port-mappings-container h4 {
            margin-top: 5px;
            color: #444;
            font-size: 16px;
        }
        
        .port-mappings-table-wrapper {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .port-mappings-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .port-mappings-table th {
            background-color: #2980b9;
            color: white;
            text-align: left;
            padding: 10px 15px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .port-mappings-table td {
            padding: 8px 15px;
            border-bottom: 1px solid #eee;
            word-wrap: break-word;
            max-width: 350px;
        }
        
        /* Make sure the protocol column is wide enough */
        .port-mappings-table td:nth-child(2),
        .port-mappings-table td:nth-child(3) {
            min-width: 300px;
        }
        
        .port-mappings-table tr:nth-child(even) {
            background-color: #f5f7fa;
        }
        
        .port-mappings-table tr:hover {
            background-color: #edf7fd;
        }
        
        /* Ensure proper wrapping of long port lists */
        .port-mappings-table td {
            vertical-align: top;
            line-height: 1.4;
            padding-top: 12px;
            padding-bottom: 12px;
        }
        
        .loading-message {
            text-align: center;
            padding: 20px;
            color: #777;
        }
        
        .custom-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: white;
            background-color: #7f8c8d;
        }
        
        .badge-custom {
            background-color: #e74c3c;
        }
        
        .badge-config {
            background-color: #27ae60;
        }
        
        .badge-default {
            background-color: #7f8c8d;
        }
        
        .action-button {
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            color: #2980b9;
            padding: 2px 8px;
            border-radius: 3px;
        }
        
        .action-button:hover {
            background-color: #edf7fd;
            text-decoration: underline;
        }
        
        .action-button.delete {
            color: #e74c3c;
        }
        
        .action-button.delete:hover {
            background-color: #fde8e8;
        }
        
        .info-note {
            font-size: 13px;
            color: #666;
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-radius: 5px;
            border-left: 4px solid #f39c12;
            margin-top: 15px;
        }
        
        .btn-secondary {
            background-color: #7f8c8d;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background-color: #95a5a6;
        }
        
        @media (max-width: 768px) {
            .add-exporter-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .port-mappings-table-wrapper {
                overflow-x: auto;
            }
            
            .edge-case-ports {
                flex-direction: column;
                margin-left: 10px;
                gap: 10px;
            }
            
            .port-input {
                width: 100%;
            }
            
            .hostname-item.edge-case {
                padding: 12px;
            }
            
            .hostname-label {
                margin-bottom: 12px;
            }
        }
        
        .form-header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .form-header h1 {
            font-size: 28px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .form-header p {
            color: #666;
            margin-top: 0;
        }
        
        .search-box {
            margin-bottom: 20px;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
        }
        
        .search-box::after {
            content: 'üîç';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }
        
        .hostname-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 20px;
        }
        
        .hostname-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .hostname-item:last-child {
            border-bottom: none;
        }
        
        .hostname-item.edge-case {
            background-color: #f8f9fa;
            padding: 12px 8px;
            border-left: 4px solid #2980b9;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 10px;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .hostname-label {
            display: flex;
            align-items: flex-start;
            flex: 0 0 70%;
            cursor: pointer;
            margin-bottom: 8px;
        }
        
        /* For non-edge case items, maintain original layout */
        .hostname-item:not(.edge-case) .hostname-label {
            margin-bottom: 0;
        }
        
        .exporter-tags {
            display: flex;
            flex-wrap: wrap;
            margin-top: 5px;
            margin-left: 5px;
            gap: 4px;
            max-width: 100%;
        }
        
        .badge {
            display: inline-block;
            padding: 2px 8px;
            margin-right: 3px;
            margin-bottom: 3px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            color: white;
            white-space: nowrap;
        }
        
        .badge-primary {
            background-color: #3498db;
        }
        
        .badge-secondary {
            background-color: #7f8c8d;
        }
        
        .badge-warning {
            background-color: #f39c12;
            color: #333;
        }
        
        .edge-case-label {
            font-size: 11px;
            background-color: #2980b9;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
        }
        
        .edge-case:hover {
            background-color: #f1f7fb;
        }
        
        .edge-case-ports {
            display: flex;
            flex: 1;
            gap: 20px;
            margin-left: 30px;
            flex-wrap: wrap;
        }
        
        .port-config-toggle {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
            margin-left: auto;
            transition: background-color 0.3s;
        }
        
        .port-config-toggle:hover {
            background-color: #2980b9;
        }
        
        .port-config-section {
            width: 100%;
            margin-top: 10px;
            padding: 12px;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .port-config-group {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .port-config-group:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .port-config-heading {
            font-size: 14px;
            color: #444;
            margin-top: 0;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .exporter-config {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f0f7fc;
            border-radius: 4px;
            border-left: 3px solid #3498db;
        }
        
        .exporter-name {
            margin: 0 0 8px 0;
            font-size: 13px;
            color: #333;
            font-weight: 600;
        }
        
        .port-input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .port-input {
            flex: 1;
            min-width: 150px; /* Ensure minimum width */
            margin-bottom: 8px;
        }
        
        .port-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
            display: block;
            font-weight: 500;
        }
        
        .port-config-input, .edge-case-port-input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            box-sizing: border-box;
        }
        
        .port-config-input:focus, .edge-case-port-input:focus {
            border-color: #2980b9;
            outline: none;
            box-shadow: 0 0 0 2px rgba(41, 128, 185, 0.2);
        }
        
        .blackbox-input {
            width: 100%;
            max-width: 120px;
        }
        
        .edge-case.needs-ports {
            animation: pulse 2s infinite;
            background-color: #fff8f8;
            border-left-color: #e74c3c;
        }
        
        .port-required {
            border-color: #e74c3c;
            background-color: #ffeaea;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.2); }
            70% { box-shadow: 0 0 0 6px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }
        
        .hostname-item input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }
        
        .hostname-details {
            display: flex;
            flex-wrap: wrap;
            font-size: 14px;
        }
        
        .hostname-fqdn {
            flex: 1;
            min-width: 60%;
            font-weight: 500;
        }
        
        .hostname-ip {
            flex: 0 0 auto;
            color: #666;
            margin-left: 10px;
        }
        
        .checkbox-controls {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            text-align: center;
            text-decoration: none;
        }
        
        .btn:hover {
            background-color: #34495e;
            transform: translateY(-2px);
        }
        
        .btn-check {
            background-color: #7f8c8d;
            font-size: 14px;
            padding: 8px 16px;
        }
        
        .btn-check:hover {
            background-color: #95a5a6;
        }
        
        .btn-primary {
            background-color: #2980b9;
            padding: 12px 24px;
            font-size: 18px;
            width: 100%;
            margin-top: 15px;
        }
        
        .btn-primary:hover {
            background-color: #3498db;
        }
        
        .stats-bar {
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 6px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .output-options {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        
        .output-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #444;
        }
        
        .output-format {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .format-option {
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .format-option input {
            margin-right: 8px;
        }
        
        .tooltip {
            position: relative;
            cursor: help;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #333;
            color: white;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.5;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        /* For tooltips on the right side elements */
        .tooltip-right .tooltiptext {
            left: auto;
            right: 0;
            margin-left: 0;
        }
        
        /* For tooltips on the left side elements */
        .tooltip-left .tooltiptext {
            left: 0;
            right: auto;
            margin-left: 0;
        }
        
        /* For bottom positioned tooltips */
        .tooltip-bottom .tooltiptext {
            bottom: auto;
            top: 125%;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .selected-count {
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .checkbox-controls {
                flex-direction: column;
            }
            
            .btn-check {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-header">
            <h1>Firewall Request Configuration</h1>
            <p>Configure servers and port mappings for your firewall request</p>
        </div>
        
        <!-- Tab Navigation -->
        <div class="tabs">
            <div class="tab-header">
                <div class="tab-btn active tooltip" data-tab="server-selection">
                    Server Selection
                    <span class="tooltiptext">Select servers from your CSV file to include in your firewall request</span>
                </div>
                <div class="tab-btn tooltip" data-tab="port-mappings">
                    Port Mappings
                    <span class="tooltiptext">View and customize port configurations for different exporters</span>
                </div>
            </div>
            
            <!-- Server Selection Tab -->
            <div class="tab-content active" id="server-selection">
        
        <form method="post" action="{{ url_for('generate_output_csv') }}" onsubmit="return validateSelection()">
            <input type="hidden" name="maas_ng_ip" value="{{ maas_ng_ip }}">
            <input type="hidden" name="maas_ng_fqdn" value="{{ maas_ng_fqdn }}">
            
            <div class="search-box tooltip">
                <input type="text" id="hostnameSearch" placeholder="Search hostnames..." oninput="filterHostnames()">
                <span class="tooltiptext tooltip-bottom">Search by hostname or IP address to filter the list</span>
            </div>
            
            <div class="stats-bar">
                <span>Total devices: <strong>{{ hostnames|length }}</strong></span>
                <span>Selected: <span class="selected-count" id="selectedCount">0</span></span>
            </div>
            
            <div class="checkbox-controls">
                <button type="button" class="btn btn-check tooltip" id="checkAll">
                    Select All
                    <span class="tooltiptext tooltip-bottom">Select all visible servers in the list</span>
                </button>
                <button type="button" class="btn btn-check tooltip" id="uncheckAll">
                    Deselect All
                    <span class="tooltiptext tooltip-bottom">Clear all server selections</span>
                </button>
                <button type="button" class="btn btn-check tooltip" onclick="toggleHostnamesWithIP()">
                    Toggle by IP Pattern
                    <span class="tooltiptext tooltip-bottom">Toggle selection of servers matching an IP pattern (e.g., 192.168)</span>
                </button>
            </div>
            
            <div class="hostname-list" id="hostnameList">
                {% for hostname in hostnames_info %}
                <div class="hostname-item {% if hostname.is_edge_case %}edge-case{% endif %}">
                    <label class="hostname-label">
                        <input type="checkbox" name="selected_hostnames" value="{{ hostname.fqdn }}" data-ip="{{ hostname.ip }}" onchange="updateSelectedCount()">
                        <input type="hidden" name="data-ip-{{ hostname.fqdn }}" value="{{ hostname.ip }}">
                        <div class="hostname-details">
                            <span class="hostname-fqdn">{{ hostname.fqdn }}</span>
                            <span class="hostname-ip">{{ hostname.ip }}</span>
                            
                            <!-- Exporter Tags Section -->
                            <div class="exporter-tags">
                                {% if hostname.is_edge_case %}
                                <span class="badge badge-warning">Edge Case</span>
                                {% endif %}
                                
                                <!-- Exporter badges -->
                                {% for exporter in hostname.exporters %}
                                    <span class="badge badge-primary">{{ exporter }}</span>
                                {% endfor %}
                                
                                <!-- Blackbox monitoring badges -->
                                {% if hostname.ssh_banner %}
                                    {% set value = hostname.ssh_banner|string|lower %}
                                    {% if value in ['true', 'yes', '1', 't', 'y'] %}
                                        <span class="badge badge-secondary">SSH Banner</span>
                                    {% endif %}
                                {% endif %}
                                
                                {% if hostname.tcp_connect or hostname.tcp_port %}
                                    {% if hostname.tcp_connect %}
                                        {% set value = hostname.tcp_connect|string|lower %}
                                        {% if value in ['true', 'yes', '1', 't', 'y'] %}
                                            <span class="badge badge-secondary">TCP Connect</span>
                                        {% endif %}
                                    {% elif hostname.tcp_port %}
                                        <span class="badge badge-secondary">TCP Connect</span>
                                    {% endif %}
                                {% endif %}
                                
                                {% if hostname.snmp %}
                                    {% set value = hostname.snmp|string|lower %}
                                    {% if value in ['true', 'yes', '1', 't', 'y'] %}
                                        <span class="badge badge-secondary">SNMP</span>
                                    {% endif %}
                                {% endif %}
                                
                                {% if hostname.ssl %}
                                    {% set value = hostname.ssl|string|lower %}
                                    {% if value in ['true', 'yes', '1', 't', 'y'] %}
                                        <span class="badge badge-secondary">SSL</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </label>
                    
                    <!-- Configure Ports Button -->
                    <button type="button" class="port-config-toggle" onclick="togglePortConfig('{{ hostname.fqdn }}')">
                        Configure Ports
                    </button>
                    
                    <!-- Port Configuration Section (Initially Hidden) -->
                    <div id="port-config-{{ hostname.fqdn }}" class="port-config-section" style="display: none;">
                        <!-- Standard Exporter Ports -->
                        {% if hostname.exporters %}
                        <div class="port-config-group">
                            <h4 class="port-config-heading">Exporter Ports</h4>
                            {% for exporter in hostname.exporters %}
                                <div class="exporter-config">
                                    <h5 class="exporter-name">{{ exporter }}</h5>
                                    <div class="port-input-grid">
                                        <div class="port-input tooltip">
                                            <label class="port-label">To Target:</label>
                                            <input type="text"
                                                   name="exporter_to_{{ exporter }}_{{ hostname.fqdn }}"
                                                   placeholder="e.g., 22,443,8080"
                                                   value="{% for protocol, port in hostname.suggested_ports.get(exporter, {}).get('src', []) %}{% if port != 'ping' %}{{ port }}{% if not loop.last and loop.nextitem[1] != 'ping' %},{% endif %}{% endif %}{% endfor %}"
                                                   class="port-config-input"
>
                                            <span class="tooltiptext">
                                                <strong>Monitoring ‚Üí Target:</strong> Ports that the monitoring server needs to connect to on this server.
                                                <br><br>
                                                Enter port numbers separated by commas (e.g., 22,443,8080).
                                            </span>
                                        </div>
                                        <div class="port-input tooltip">
                                            <label class="port-label">From Target:</label>
                                            <input type="text"
                                                   name="exporter_from_{{ exporter }}_{{ hostname.fqdn }}"
                                                   placeholder="e.g., 162,514"
                                                   value="{% for protocol, port in hostname.suggested_ports.get(exporter, {}).get('dst', []) %}{% if port != 'ping' %}{{ port }}{% if not loop.last and loop.nextitem[1] != 'ping' %},{% endif %}{% endif %}{% endfor %}"
                                                   class="port-config-input"
>
                                            <span class="tooltiptext">
                                                <strong>Target ‚Üí Monitoring:</strong> Return traffic ports from this server back to the monitoring server.
                                                <br><br>
                                                Enter port numbers separated by commas (e.g., 162,514). Optional.
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <!-- Blackbox Monitoring Ports -->
                        {% if hostname.is_edge_case %}
                        <div class="port-config-group">
                            <h4 class="port-config-heading">Blackbox Monitoring Ports</h4>
                            <!-- SSH Banner port -->
                            {% if hostname.ssh_banner and hostname.ssh_banner|lower in ['true', 'yes', '1'] %}
                            <div class="port-input tooltip">
                                <label class="port-label">SSH Banner Port:</label>
                                <input type="text"
                                       name="ssh_banner_port_{{ hostname.fqdn }}"
                                       placeholder="22"
                                       value="{{ hostname.suggested_ports.get('ssh_banner', '22') }}"
                                       class="port-config-input blackbox-input"
>
                                <span class="tooltiptext">
                                    Port used for SSH banner monitoring. Default is 22.
                                </span>
                            </div>
                            {% endif %}
                            
                            <!-- TCP Connect port -->
                            {% if hostname.tcp_connect and hostname.tcp_connect|lower in ['true', 'yes', '1'] 
                               or hostname.tcp_port %}
                            <div class="port-input tooltip">
                                <label class="port-label">TCP Connect Port:</label>
                                <input type="text"
                                       name="tcp_connect_port_{{ hostname.fqdn }}"
                                       placeholder="80"
                                       value="{{ hostname.tcp_port or hostname.suggested_ports.get('tcp_connect', '') }}"
                                       class="port-config-input blackbox-input"
>
                                <span class="tooltiptext">
                                    Port used for TCP connectivity check. Specify a single port number.
                                </span>
                            </div>
                            {% endif %}
                            
                            <!-- SNMP port -->
                            {% if hostname.snmp and hostname.snmp|lower in ['true', 'yes', '1'] %}
                            <div class="port-input tooltip">
                                <label class="port-label">SNMP Port:</label>
                                <input type="text"
                                       name="snmp_port_{{ hostname.fqdn }}"
                                       placeholder="161"
                                       value="{{ hostname.suggested_ports.get('snmp', '161') }}"
                                       class="port-config-input blackbox-input"
>
                                <span class="tooltiptext">
                                    Port used for SNMP monitoring. Default is 161.
                                </span>
                            </div>
                            {% endif %}
                            
                            <!-- SSL port -->
                            {% if hostname.ssl and hostname.ssl|lower in ['true', 'yes', '1'] %}
                            <div class="port-input tooltip">
                                <label class="port-label">SSL Port:</label>
                                <input type="text"
                                       name="ssl_port_{{ hostname.fqdn }}"
                                       placeholder="443"
                                       value="{{ hostname.suggested_ports.get('ssl', '443') }}"
                                       class="port-config-input blackbox-input"
>
                                <span class="tooltiptext">
                                    Port used for SSL monitoring. Default is 443.
                                </span>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <!-- Custom Additional Ports (always shown) -->
                        <div class="port-config-group">
                            <h4 class="port-config-heading">Custom Additional Ports</h4>
                            <div class="port-input-grid">
                                <div class="port-input tooltip">
                                    <label class="port-label">To Target:</label>
                                    <input type="text"
                                           name="to_target_{{ hostname.fqdn }}"
                                           placeholder="e.g., 22,443,8080"
                                           value="{{ hostname.suggested_to_target }}"
                                           class="port-config-input"
>
                                    <span class="tooltiptext">
                                        <strong>Additional Monitoring ‚Üí Target:</strong> Extra ports that the monitoring server needs to connect to.
                                        <br><br>
                                        Enter port numbers separated by commas (e.g., 22,443,8080).
                                    </span>
                                </div>
                                <div class="port-input tooltip">
                                    <label class="port-label">From Target:</label>
                                    <input type="text"
                                           name="from_target_{{ hostname.fqdn }}"
                                           placeholder="e.g., 162,514"
                                           value="{{ hostname.suggested_from_target }}"
                                           class="port-config-input"
>
                                    <span class="tooltiptext">
                                        <strong>Additional Target ‚Üí Monitoring:</strong> Extra return traffic ports.
                                        <br><br>
                                        Enter port numbers separated by commas (e.g., 162,514). Optional.
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="output-options">
                <h3 class="output-title">Output Format</h3>
                <div class="output-format">
                    <label class="format-option">
                        <input type="radio" name="output_format" value="csv" checked>
                        CSV
                    </label>
                    <label class="format-option">
                        <input type="radio" name="output_format" value="excel">
                        Excel
                    </label>
                    <label class="format-option">
                        <input type="radio" name="output_format" value="pdf">
                        PDF
                    </label>
                    <label class="format-option tooltip">
                        <input type="radio" name="output_format" value="check_csv">
                        Firewall Check CSV
                        <span class="tooltiptext">Creates a CSV with only monitoring server to target entries for port testing</span>
                    </label>
                </div>
                
                <h4 style="margin: 15px 0 10px 0; font-size: 15px; color: #555;">Firewall-Specific Formats</h4>
                <div class="output-format">
                    <label class="format-option tooltip">
                        <input type="radio" name="output_format" value="cisco">
                        Cisco ASA
                        <span class="tooltiptext">Generate Cisco ASA compatible firewall rules</span>
                    </label>
                    <label class="format-option tooltip">
                        <input type="radio" name="output_format" value="juniper">
                        Juniper SRX
                        <span class="tooltiptext">Generate Juniper SRX compatible security policies</span>
                    </label>
                    <label class="format-option tooltip">
                        <input type="radio" name="output_format" value="paloalto">
                        Palo Alto
                        <span class="tooltiptext">Generate Palo Alto Networks compatible rules</span>
                    </label>
                    <label class="format-option tooltip">
                        <input type="radio" name="output_format" value="iptables">
                        Linux iptables
                        <span class="tooltiptext">Generate Linux iptables rules script</span>
                    </label>
                </div>
                
                <div class="format-info" style="margin-top: 10px; font-size: 13px; color: #666; padding: 8px; background-color: #f5f5f5; border-radius: 4px; display: none;">
                    <!-- Standard formats info -->
                    <div class="info-csv">
                        <p style="margin: 0;">
                            <strong>CSV Format:</strong> Standard comma-separated values format. Compatible with all spreadsheet applications.
                        </p>
                    </div>
                    <div class="info-excel">
                        <p style="margin: 0;">
                            <strong>Excel Format:</strong> Microsoft Excel spreadsheet (.xlsx) format with proper column formatting.
                        </p>
                    </div>
                    <div class="info-pdf">
                        <p style="margin: 0;">
                            <strong>PDF Format:</strong> Formatted PDF document with color-coded protocols for better readability.
                        </p>
                    </div>
                    
                    <!-- Firewall check info -->
                    <div class="info-check_csv">
                        <p style="margin: 0 0 8px 0;">
                            <strong>Firewall Check CSV:</strong> Contains only the monitoring server to target entries for testing port connectivity.
                        </p>
                        <p style="margin: 0;">
                            Download the <a href="{{ url_for('download_check_script') }}" style="color: #2980b9; text-decoration: none;">firewall check script</a> 
                            to automatically test if the ports are open.
                        </p>
                    </div>
                    
                    <!-- Firewall-specific formats info -->
                    <div class="info-cisco">
                        <p style="margin: 0;">
                            <strong>Cisco ASA Format:</strong> Access control list (ACL) entries compatible with Cisco ASA firewalls.
                        </p>
                    </div>
                    <div class="info-juniper">
                        <p style="margin: 0;">
                            <strong>Juniper SRX Format:</strong> Security policy and application definitions for Juniper SRX devices.
                        </p>
                    </div>
                    <div class="info-paloalto">
                        <p style="margin: 0;">
                            <strong>Palo Alto Format:</strong> XML-formatted security rules for Palo Alto Networks firewalls.
                        </p>
                    </div>
                    <div class="info-iptables">
                        <p style="margin: 0;">
                            <strong>Linux iptables Format:</strong> Shell script with iptables commands for Linux hosts.
                        </p>
                    </div>
                </div>
            </div>
            
            <script>
                // Show appropriate info section based on selected output format
                document.addEventListener('DOMContentLoaded', function() {
                    const formatRadios = document.querySelectorAll('input[name="output_format"]');
                    const formatInfo = document.querySelector('.format-info');
                    const infoSections = document.querySelectorAll('[class^="info-"]');
                    
                    // Show initial format info (CSV by default)
                    formatInfo.style.display = 'block';
                    document.querySelector('.info-csv').style.display = 'block';
                    
                    formatRadios.forEach(radio => {
                        radio.addEventListener('change', function() {
                            // Show the main info container
                            formatInfo.style.display = 'block';
                            
                            // Hide all info sections
                            infoSections.forEach(section => {
                                section.style.display = 'none';
                            });
                            
                            // Show only the relevant info section
                            const infoToShow = document.querySelector(`.info-${this.value}`);
                            if (infoToShow) {
                                infoToShow.style.display = 'block';
                            }
                        });
                    });
                });
            </script>
            
            <button type="submit" class="btn btn-primary tooltip">
                Generate Firewall Request
                <span class="tooltiptext tooltip-left">
                    Create firewall rules based on your selected servers and configured port mappings
                </span>
            </button>
        </form>
            </div>
            
            <!-- Port Mappings Tab -->
            <div class="tab-content" id="port-mappings">
                <h3>Custom Exporter Configuration</h3>
                <p class="section-description">Add custom exporters or modify existing port mappings</p>
                
                <!-- Add New Exporter Form -->
                <div class="custom-exporter-form">
                    <h4>Add New Exporter</h4>
                    <form id="new-exporter-form" onsubmit="event.preventDefault(); addNewExporter();">
                        <div class="add-exporter-grid">
                            <div class="exporter-field tooltip">
                                <label for="new-exporter-name">Exporter Name</label>
                                <input type="text" id="new-exporter-name" placeholder="e.g., exporter_custom" pattern="[a-zA-Z0-9_-]+" required>
                                <div style="height: 18px;"></div> <!-- Spacer to align with other fields -->
                                <span class="tooltiptext">
                                    Name for the custom exporter configuration.
                                    <br><br>
                                    Must contain only letters, numbers, underscores, and hyphens.
                                    <br>
                                    Example: exporter_custom_app
                                </span>
                            </div>
                            <div class="exporter-field tooltip">
                                <label for="new-to-target">To Target Ports</label>
                                <input type="text" id="new-to-target" placeholder="e.g., 22,443,8080" pattern="[0-9,]+" required>
                                <small style="display: block; margin-top: 3px;">Comma-separated TCP ports</small>
                                <span class="tooltiptext">
                                    <strong>Monitoring ‚Üí Target:</strong> Ports that the monitoring server needs to connect to.
                                    <br><br>
                                    Enter comma-separated port numbers.
                                    <br>
                                    Example: 22,443,8080
                                </span>
                            </div>
                            <div class="exporter-field tooltip">
                                <label for="new-from-target">From Target Ports</label>
                                <input type="text" id="new-from-target" placeholder="e.g., 162,514" pattern="[0-9,]*">
                                <small style="display: block; margin-top: 3px;">Comma-separated TCP ports (optional)</small>
                                <span class="tooltiptext">
                                    <strong>Target ‚Üí Monitoring:</strong> Return traffic ports from targets back to the monitoring server.
                                    <br><br>
                                    Enter comma-separated port numbers. This field is optional.
                                    <br>
                                    Example: 162,514
                                </span>
                            </div>
                        </div>
                        <div style="margin-top: 15px; text-align: center;">
                            <button type="submit" class="btn-add tooltip" id="add-exporter-btn" style="max-width: 200px; margin: 0 auto;">
                                Add Exporter
                                <span class="tooltiptext">
                                    Add this custom exporter configuration to your session.
                                    <br><br>
                                    Custom exporters will be available for use in any firewall requests you generate in this session.
                                </span>
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Port Mappings Table -->
                <div class="port-mappings-container">
                    <h4>Current Port Mappings</h4>
                    <div class="info-note" style="margin-bottom: 15px;">
                        <p>Port mappings are loaded from: configuration file &gt; session custom mappings &gt; built-in defaults.</p>
                        <p>View full <a href="{{ url_for('config_status') }}" target="_blank" style="color: #2980b9;">configuration details</a> or 
                        <a href="#" id="export-config-button" style="color: #2980b9;">export current mappings</a> to a YAML file.</p>
                    </div>
                    <div class="port-mappings-table-wrapper">
                        <table class="port-mappings-table" id="port-mappings-table">
                            <thead>
                                <tr>
                                    <th class="tooltip">
                                        Exporter Name
                                        <span class="tooltiptext tooltip-bottom">
                                            Unique identifier for this exporter configuration
                                        </span>
                                    </th>
                                    <th class="tooltip">
                                        To Target (Monitoring‚ÜíTarget)
                                        <span class="tooltiptext tooltip-bottom">
                                            Ports that monitoring servers need to connect to on target servers
                                        </span>
                                    </th>
                                    <th class="tooltip">
                                        From Target (Target‚ÜíMonitoring)
                                        <span class="tooltiptext tooltip-bottom">
                                            Return traffic ports from target servers back to monitoring servers
                                        </span>
                                    </th>
                                    <th class="tooltip">
                                        Source
                                        <span class="tooltiptext tooltip-bottom">
                                            Whether this is from the config file, a user-defined custom mapping, or a built-in default
                                        </span>
                                    </th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="port-mappings-body">
                                <!-- Port mappings will be loaded here via JavaScript -->
                                <tr class="loading-row">
                                    <td colspan="5" class="loading-message">Loading port mappings...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <p class="info-note">
                        <strong>Note:</strong> Custom exporters are stored for the current session only. They will be used for any firewall requests generated during this session.
                    </p>
                </div>
                
                <div class="tab-buttons">
                    <button type="button" class="btn btn-secondary" id="back-to-servers-btn">Back to Server Selection</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize
        updateSelectedCount();
        setupEdgeCasePortInputs();
        initializeTabs();
        setupPortMappingsTab();
        setupPortConfigurationUI();
        
        // Function to toggle all checkboxes
        document.getElementById('checkAll').addEventListener('click', function() {
            var checkboxes = document.getElementsByName('selected_hostnames');
            for (var i = 0; i < checkboxes.length; i++) {
                if (!checkboxes[i].parentElement.parentElement.style.display || 
                    checkboxes[i].parentElement.parentElement.style.display !== 'none') {
                    checkboxes[i].checked = true;
                }
            }
            updateSelectedCount();
        });
        
        document.getElementById('uncheckAll').addEventListener('click', function() {
            var checkboxes = document.getElementsByName('selected_hostnames');
            for (var i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = false;
            }
            updateSelectedCount();
        });
        
        // Port Configuration UI Functions
        function setupPortConfigurationUI() {
            // Add checkbox selection when clicking on port input fields
            const portInputs = document.querySelectorAll('.port-config-input');
            portInputs.forEach(input => {
                input.addEventListener('input', function() {
                    // Get the hostname from the input name (format: xxx_hostname)
                    const hostname = this.name.split('_').slice(-1)[0];
                    const checkbox = document.querySelector(`input[name="selected_hostnames"][value="${hostname}"]`);
                    if (checkbox && this.value.trim() !== '') {
                        checkbox.checked = true;
                        updateSelectedCount();
                    }
                });
            });
        }
        
        // Toggle port configuration visibility
        function togglePortConfig(hostname) {
            const configSection = document.getElementById(`port-config-${hostname}`);
            if (configSection) {
                const isVisible = configSection.style.display !== 'none';
                
                // Hide all other sections first
                document.querySelectorAll('.port-config-section').forEach(section => {
                    section.style.display = 'none';
                });
                
                // Toggle this section
                configSection.style.display = isVisible ? 'none' : 'block';
                
                // Auto-select the hostname when expanding port configuration
                if (!isVisible) {
                    const checkbox = document.querySelector(`input[name="selected_hostnames"][value="${hostname}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        updateSelectedCount();
                    }
                }
            }
        }
        
        // Function to toggle all port configurations
        function toggleAllPortConfigs(show) {
            const configSections = document.querySelectorAll('.port-config-section');
            configSections.forEach(section => {
                section.style.display = show ? 'block' : 'none';
            });
        }
        
        // Function to filter hostnames based on search input
        function filterHostnames() {
            var input = document.getElementById('hostnameSearch');
            var filter = input.value.toLowerCase();
            var items = document.getElementsByClassName('hostname-item');
            
            for (var i = 0; i < items.length; i++) {
                var hostname = items[i].querySelector('.hostname-fqdn').textContent.toLowerCase();
                var ip = items[i].querySelector('.hostname-ip').textContent.toLowerCase();
                
                if (hostname.indexOf(filter) > -1 || ip.indexOf(filter) > -1) {
                    items[i].style.display = "";
                } else {
                    items[i].style.display = "none";
                }
            }
        }
        
        // Function to toggle hostnames based on IP pattern
        function toggleHostnamesWithIP() {
            var pattern = prompt("Enter the IP pattern to select (e.g., 192.168):");
            if (pattern) {
                var checkboxes = document.getElementsByName('selected_hostnames');
                for (var i = 0; i < checkboxes.length; i++) {
                    var ip = checkboxes[i].getAttribute('data-ip');
                    if (ip.includes(pattern)) {
                        checkboxes[i].checked = !checkboxes[i].checked;
                    }
                }
                updateSelectedCount();
            }
        }
        
        // Function to update selected count
        function updateSelectedCount() {
            var checkboxes = document.getElementsByName('selected_hostnames');
            var count = 0;
            for (var i = 0; i < checkboxes.length; i++) {
                if (checkboxes[i].checked) {
                    count++;
                }
            }
            document.getElementById('selectedCount').textContent = count;
        }
        
        // Setup edge case port input fields to auto-select the hostname
        function setupEdgeCasePortInputs() {
            var edgeCaseItems = document.querySelectorAll('.edge-case');
            edgeCaseItems.forEach(function(item) {
                // Get the port input fields
                var portInputs = item.querySelectorAll('.edge-case-port-input');
                // Get the checkbox
                var checkbox = item.querySelector('input[type="checkbox"]');
                
                if (portInputs.length && checkbox) {
                    // Add event listeners to port input fields
                    portInputs.forEach(function(input) {
                        input.addEventListener('input', function() {
                            // If user enters anything in a port field, check the checkbox
                            if (input.value.trim() !== '') {
                                checkbox.checked = true;
                                updateSelectedCount();
                            }
                            // Update validation styling
                            updateEdgeCaseValidation();
                        });
                    });
                    
                    // Add event listener to the checkbox too
                    checkbox.addEventListener('change', function() {
                        updateEdgeCaseValidation();
                    });
                }
            });
            
            // Initial validation check
            updateEdgeCaseValidation();
        }
        
        // Function to update validation styling for edge cases
        function updateEdgeCaseValidation() {
            var edgeCaseItems = document.querySelectorAll('.edge-case');
            
            edgeCaseItems.forEach(function(item) {
                var checkbox = item.querySelector('input[type="checkbox"]');
                var portInputs = item.querySelectorAll('.edge-case-port-input');
                
                if (checkbox && checkbox.checked) {
                    // Check if any port is filled in
                    var hasPort = false;
                    portInputs.forEach(function(input) {
                        if (input.value.trim() !== '') {
                            hasPort = true;
                        }
                    });
                    
                    // Apply validation styling
                    if (!hasPort) {
                        item.classList.add('needs-ports');
                        portInputs.forEach(function(input) {
                            input.classList.add('port-required');
                        });
                    } else {
                        item.classList.remove('needs-ports');
                        portInputs.forEach(function(input) {
                            input.classList.remove('port-required');
                        });
                    }
                } else {
                    // Not checked, remove validation styling
                    item.classList.remove('needs-ports');
                    portInputs.forEach(function(input) {
                        input.classList.remove('port-required');
                    });
                }
            });
        }
        
        // Function to validate form before submission
        function validateSelection() {
            var checkboxes = document.getElementsByName('selected_hostnames');
            var selected = false;
            
            for (var i = 0; i < checkboxes.length; i++) {
                if (checkboxes[i].checked) {
                    selected = true;
                    break;
                }
            }
            
            if (!selected) {
                alert("Please select at least one hostname.");
                return false;
            }
            
            // Collect all port input validations
            var invalidPorts = false;
            
            // 1. Validate all port inputs (both standard and edge case)
            var allPortInputs = document.querySelectorAll('.port-config-input');
            allPortInputs.forEach(function(input) {
                // Only validate inputs for selected hostnames
                const inputNameParts = input.name.split('_');
                const hostname = inputNameParts[inputNameParts.length - 1];
                const checkbox = document.querySelector(`input[name="selected_hostnames"][value="${hostname}"]`);
                
                if (checkbox && checkbox.checked) {
                    // Check if port values are valid (numbers, commas, and special values like 'ping')
                    var value = input.value.trim();
                    if (value) {
                        // Allow numbers, commas, and special values like 'ping', 'true', 'yes', etc.
                        var ports = value.split(',');
                        var hasInvalid = false;
                        
                        for (var i = 0; i < ports.length; i++) {
                            var port = ports[i].trim();
                            var portLower = port.toLowerCase();
                            // Allow special values or numeric ports
                            if (portLower !== 'ping' && 
                                portLower !== 'true' && 
                                portLower !== 'yes' && 
                                portLower !== '1' && 
                                portLower !== 't' && 
                                portLower !== 'y' && 
                                !/^\d+$/.test(port)) {
                                hasInvalid = true;
                                break;
                            }
                        }
                        
                        if (hasInvalid) {
                            alert(`Invalid port format for ${hostname}: "${input.value}". Please use numbers or special values like "ping", "true", "yes", separated by commas.`);
                            invalidPorts = true;
                            input.classList.add('port-required');
                        } else {
                            input.classList.remove('port-required');
                        }
                    }
                }
            });
            
            // 2. Validate edge cases specifically (they require at least one port)
            var edgeCaseItems = document.querySelectorAll('.edge-case');
            edgeCaseItems.forEach(function(item) {
                var checkbox = item.querySelector('input[type="checkbox"]');
                
                // Only validate if this edge case is selected
                if (checkbox && checkbox.checked) {
                    var portInputs = item.querySelectorAll('.port-config-input');
                    var hostnameFqdn = item.querySelector('.hostname-fqdn').textContent;
                    
                    // Check if at least one port is specified
                    var hasPort = false;
                    
                    portInputs.forEach(function(input) {
                        if (input.value.trim() !== '') {
                            hasPort = true;
                        }
                    });
                    
                    // Require at least one port for selected edge cases
                    if (!hasPort) {
                        alert("Please specify at least one port for the edge case server: " + hostnameFqdn);
                        invalidPorts = true;
                        // Mark all port inputs as required
                        portInputs.forEach(input => input.classList.add('port-required'));
                    } else {
                        // Remove required marking
                        portInputs.forEach(input => input.classList.remove('port-required'));
                    }
                }
            });
            
            if (invalidPorts) {
                return false;
            }
            
            // Submit custom port mappings to the server before form submission
            try {
                // Get custom mappings from local storage
                const storedMappings = localStorage.getItem('customPortMappings');
                if (storedMappings) {
                    const customMappings = JSON.parse(storedMappings);
                    
                    // Send to server
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/api/port_mappings', false); // Synchronous request
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.send(JSON.stringify(customMappings));
                    
                    if (xhr.status !== 200) {
                        console.error('Error submitting custom port mappings:', xhr.responseText);
                    }
                }
            } catch (error) {
                console.error('Error processing custom port mappings:', error);
            }
            
            return true;
        }
        
        // Tab functionality
        function initializeTabs() {
            var tabButtons = document.querySelectorAll('.tab-btn');
            var tabContents = document.querySelectorAll('.tab-content');
            
            // Add click event to each tab button
            tabButtons.forEach(function(button) {
                button.addEventListener('click', function() {
                    // Get the target tab ID from data-tab attribute
                    var targetTabId = this.getAttribute('data-tab');
                    
                    // Remove active class from all buttons and tabs
                    tabButtons.forEach(function(btn) {
                        btn.classList.remove('active');
                    });
                    
                    tabContents.forEach(function(content) {
                        content.classList.remove('active');
                    });
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Add active class to target tab content
                    document.getElementById(targetTabId).classList.add('active');
                });
            });
            
            // Add export configuration functionality
            var exportButton = document.getElementById('export-config-button');
            if (exportButton) {
                exportButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    exportCurrentConfiguration();
                });
            }
            
            // Back to server selection button functionality
            var backButton = document.getElementById('back-to-servers-btn');
            if (backButton) {
                backButton.addEventListener('click', function() {
                    // Activate the server selection tab
                    tabButtons.forEach(function(btn) {
                        btn.classList.remove('active');
                        if (btn.getAttribute('data-tab') === 'server-selection') {
                            btn.classList.add('active');
                        }
                    });
                    
                    tabContents.forEach(function(content) {
                        content.classList.remove('active');
                    });
                    
                    document.getElementById('server-selection').classList.add('active');
                });
            }
        }
        
        // Export current configuration as YAML file
        function exportCurrentConfiguration() {
            try {
                // Get all the current port mappings (both from server and custom)
                const xhr = new XMLHttpRequest();
                xhr.open('GET', '/api/port_mappings', false); // Synchronous for simplicity
                xhr.send();
                
                if (xhr.status === 200) {
                    const portMappings = JSON.parse(xhr.responseText);
                    
                    // Format as YAML-like structure
                    let yamlContent = "# Port Mapper Configuration\n\n";
                    yamlContent += "# Column mappings for different exporter types\n";
                    yamlContent += "column_mappings:\n";
                    
                    // We don't have direct access to column mappings, so use generic ones based on port mappings
                    Object.keys(portMappings).forEach(exporterName => {
                        yamlContent += `  ${exporterName}:\n`;
                        
                        // Determine if this is likely an OS or app exporter based on naming convention
                        if (exporterName.includes('linux') || exporterName.includes('windows')) {
                            yamlContent += `    column_name: "Exporter_name_os"\n`;
                        } else {
                            yamlContent += `    column_names:\n`;
                            yamlContent += `      - "Exporter_name_app"\n`;
                            yamlContent += `      - "Exporter_name_app_2"\n`;
                            yamlContent += `      - "Exporter_name_app_3"\n`;
                        }
                    });
                    
                    yamlContent += "\n# Port mapping configurations\n";
                    yamlContent += "port_mappings:\n";
                    
                    // Add all port mappings
                    Object.keys(portMappings).sort().forEach(exporterName => {
                        const mapping = portMappings[exporterName];
                        
                        yamlContent += `  ${exporterName}:\n`;
                        
                        // Source (to target) ports
                        yamlContent += "    src:\n";
                        if (mapping.src && mapping.src.length > 0) {
                            mapping.src.forEach(portEntry => {
                                let protocol, port;
                                if (Array.isArray(portEntry)) {
                                    [protocol, port] = portEntry;
                                } else if (typeof portEntry === 'object') {
                                    protocol = portEntry[0];
                                    port = portEntry[1];
                                }
                                yamlContent += `      - ["${protocol}", "${port}"]\n`;
                            });
                        } else {
                            yamlContent += "      []\n";
                        }
                        
                        // Destination (from target) ports
                        yamlContent += "    dst:\n";
                        if (mapping.dst && mapping.dst.length > 0) {
                            mapping.dst.forEach(portEntry => {
                                let protocol, port;
                                if (Array.isArray(portEntry)) {
                                    [protocol, port] = portEntry;
                                } else if (typeof portEntry === 'object') {
                                    protocol = portEntry[0];
                                    port = portEntry[1];
                                }
                                yamlContent += `      - ["${protocol}", "${port}"]\n`;
                            });
                        } else {
                            yamlContent += "      []\n";
                        }
                    });
                    
                    // Create a download link
                    const blob = new Blob([yamlContent], { type: 'text/yaml' });
                    const url = URL.createObjectURL(blob);
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
                    const filename = `port_config_${timestamp}.yaml`;
                    
                    // Create an anchor element and trigger the download
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Clean up
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 0);
                } else {
                    alert('Error fetching port mappings. Please try again.');
                }
            } catch (error) {
                console.error('Error exporting configuration:', error);
                alert('Error exporting configuration: ' + error.message);
            }
        }
        
        // Port Mappings functionality
        function setupPortMappingsTab() {
            // Load the built-in port mappings from app.py
            loadPortMappings();
            
            // Add new exporter button functionality
            var addExporterBtn = document.getElementById('add-exporter-btn');
            if (addExporterBtn) {
                addExporterBtn.addEventListener('click', function() {
                    addNewExporter();
                });
            }
        }
        
        // Function to load port mappings from the server
        function loadPortMappings() {
            // Initialize with a complete set of all built-in port mappings from app.py
            let builtInMappings = {
                "exporter_cms": {
                    "src": [["TCP", "22"], ["ICMP", "ping"], ["TCP", "443"], ["SSL", "443"]],
                    "dst": [],
                    "custom": false
                },
                "exporter_aes": {
                    "src": [["TCP", "22"], ["ICMP", "ping"], ["TCP", "443"], ["SSL", "8443"]],
                    "dst": [["UDP", "514"], ["TCP", "514"], ["UDP", "162"]],
                    "custom": false
                },
                "exporter_aessnmp": {
                    "src": [["TCP", "22"], ["UDP", "161"], ["TCP", "443"], ["ICMP", "ping"], ["SSL", "443"]],
                    "dst": [["UDP", "162"], ["UDP", "514"], ["TCP", "514"]],
                    "custom": false
                },
                "exporter_gateway": {
                    "src": [["UDP", "161"], ["TCP", "22"], ["ICMP", "ping"]],
                    "dst": [["UDP", "162"]],
                    "custom": false
                },
                "exporter_ams": {
                    "src": [["TCP", "22"], ["UDP", "161"], ["TCP", "8443"], ["ICMP", "ping"], ["SSL", "8443"]],
                    "dst": [["UDP", "514"], ["TCP", "514"]],
                    "custom": false
                },
                "exporter_sm": {
                    "src": [["TCP", "22"], ["ICMP", "ping"]],
                    "dst": [["UDP", "162"]],
                    "custom": false
                },
                "exporter_avayasbc": {
                    "src": [["TCP", "22"], ["TCP", "222"], ["UDP", "161"], ["TCP", "443"], ["ICMP", "ping"], ["SSL", "443"]],
                    "dst": [["UDP", "162"], ["UDP", "514"], ["TCP", "514"]],
                    "custom": false
                },
                "exporter_aaep": {
                    "src": [["TCP", "22"], ["TCP", "5432"], ["UDP", "161"], ["TCP", "443"], ["ICMP", "ping"], ["SSL", "443"]],
                    "dst": [["UDP", "162"], ["UDP", "514"], ["TCP", "514"]],
                    "custom": false
                },
                "exporter_mpp": {
                    "src": [["TCP", "22"], ["ICMP", "ping"]],
                    "dst": [],
                    "custom": false
                },
                "exporter_windows": {
                    "src": [["TCP", "9182"], ["ICMP", "ping"]],
                    "dst": [["UDP", "514"], ["TCP", "514"]],
                    "custom": false
                },
                "exporter_linux": {
                    "src": [["TCP", "22"], ["ICMP", "ping"]],
                    "dst": [],
                    "custom": false
                },
                "exporter_ipo": {
                    "src": [["TCP", "22"], ["TCP", "443"], ["UDP", "161"]],
                    "dst": [["UDP", "162"], ["UDP", "514"], ["TCP", "514"]],
                    "custom": false
                },
                "exporter_iq": {
                    "src": [["TCP", "22"], ["TCP", "443"], ["ICMP", "ping"]],
                    "dst": [],
                    "custom": false
                },
                "exporter_weblm": {
                    "src": [["TCP", "22"], ["TCP", "443"], ["TCP", "52233"], ["ICMP", "ping"], ["SSL", "443"], ["SSL", "52233"]],
                    "dst": [],
                    "custom": false
                },
                "exporter_aacc": {
                    "src": [["TCP", "9182"], ["TCP", "8443"], ["ICMP", "ping"], ["SSL", "443"]],
                    "dst": [["UDP", "514"], ["TCP", "514"]],
                    "custom": false
                },
                "exporter_wfodb": {
                    "src": [["TCP", "1433"], ["TCP", "9182"], ["ICMP", "ping"]],
                    "dst": [["UDP", "514"], ["TCP", "514"]],
                    "custom": false
                },
                "exporter_verint": {
                    "src": [["TCP", "9182"], ["ICMP", "ping"], ["TCP", "8443"], ["ICMP", "ping"], ["SSL", "8443"]],
                    "dst": [["UDP", "514"], ["TCP", "514"]],
                    "custom": false
                },
                "exporter_network": {
                    "src": [["UDP", "161"], ["ICMP", "ping"]],
                    "dst": [["UDP", "162"], ["UDP", "514"], ["TCP", "514"]],
                    "custom": false
                },
                "exporter_tcti": {
                    "src": [["TCP", "8080"], ["ICMP", "ping"]],
                    "dst": [["UDP", "514"], ["TCP", "514"]],
                    "custom": false
                },
                "exporter_callback": {
                    "src": [["TCP", "1433"], ["ICMP", "ping"]],
                    "dst": [["UDP", "514"], ["TCP", "514"]],
                    "custom": false
                },
                "exporter_nuancelm": {
                    "src": [["TCP", "9182"], ["TCP", "27000"], ["ICMP", "ping"]],
                    "dst": [["UDP", "514"], ["TCP", "514"]],
                    "custom": false
                },
                "exporter_jmx": {
                    "src": [["TCP", "7080"], ["ICMP", "ping"]],
                    "dst": [],
                    "custom": false
                },
                "exporter_breeze": {
                    "src": [["TCP", "22"], ["ICMP", "ping"], ["SSL", "443"]],
                    "dst": [["UDP", "162"], ["UDP", "514"], ["TCP", "514"]],
                    "custom": false
                },
                "exporter_acm": {
                    "src": [["TCP", "22"], ["TCP", "5022"], ["TCP", "443"], ["UDP", "161"], ["ICMP", "ping"], ["SSL", "443"]],
                    "dst": [["UDP", "514"], ["TCP", "514"], ["UDP", "162"]],
                    "custom": false
                },
                "exporter_vmware": {
                    "src": [["TCP", "22"], ["ICMP", "ping"], ["TCP", "443"]],
                    "dst": [],
                    "custom": false
                },
                "exporter_kafka": {
                    "src": [["TCP", "9092"]],
                    "dst": [],
                    "custom": false
                },
                "exporter_drac": {
                    "src": [["TCP", "22"], ["ICMP", "ping"], ["UDP", "161"]],
                    "dst": [["UDP", "162"], ["UDP", "514"], ["TCP", "514"]],
                    "custom": false
                },
                "exporter_pfsense": {
                    "src": [["TCP", "22"], ["ICMP", "ping"], ["UDP", "161"]],
                    "dst": [["UDP", "162"], ["UDP", "514"], ["TCP", "514"]],
                    "custom": false
                },
                "exporter_aic": {
                    "src": [["TCP", "9183"], ["ICMP", "ping"], ["SSL", "443"]],
                    "dst": [["UDP", "514"], ["TCP", "514"]],
                    "custom": false
                },
                "exporter_voiceportal": {
                    "src": [["TCP", "5432"], ["ICMP", "ping"], ["TCP", "443"], ["TCP", "22"]],
                    "dst": [],
                    "custom": false
                },
                "exporter_aam": {
                    "src": [["ICMP", "ping"], ["TCP", "8443"], ["TCP", "22"], ["UDP", "161"], ["SSL", "8443"]],
                    "dst": [["UDP", "514"], ["TCP", "514"], ["UDP", "162"]],
                    "custom": false
                },
                "exporter_pc5": {
                    "src": [["ICMP", "ping"], ["TCP", "22"]],
                    "dst": [],
                    "custom": false
                },
                "exporter_audiocodes": {
                    "src": [["ICMP", "ping"], ["TCP", "22"], ["UDP", "161"], ["SSL", "443"]],
                    "dst": [["UDP", "514"], ["TCP", "514"], ["UDP", "162"], ["SSL", "443"]],
                    "custom": false
                },
                "exporter_redis": {
                    "src": [["TCP", "6379"]],
                    "dst": [],
                    "custom": false
                }
            };
            
            // Attempt to fetch the complete built-in port mappings from the server
            let fetchSuccessful = false;
            try {
                const xhr = new XMLHttpRequest();
                // Using async with a longer timeout for better user experience
                xhr.open('GET', '/api/port_mappings', true);
                xhr.timeout = 2000; // 2 second timeout
                
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        try {
                            const serverMappings = JSON.parse(xhr.responseText);
                            
                            // Convert server mappings to client format and mark as built-in
                            for (const [exporterName, mapping] of Object.entries(serverMappings)) {
                                builtInMappings[exporterName] = {
                                    src: mapping.src.map(entry => Array.isArray(entry) ? entry : [entry[0], entry[1]]),
                                    dst: mapping.dst.map(entry => Array.isArray(entry) ? entry : [entry[0], entry[1]]),
                                    custom: false
                                };
                            }
                            fetchSuccessful = true;
                            
                            // Now render the mappings since the XHR is complete
                            renderPortMappings(builtInMappings);
                        } catch (parseError) {
                            console.error('Error parsing server mappings:', parseError);
                            renderPortMappings(builtInMappings);
                        }
                    } else {
                        console.warn('Failed to fetch built-in port mappings from server, using defaults');
                        renderPortMappings(builtInMappings);
                    }
                };
                
                xhr.onerror = function() {
                    console.error('XHR error when fetching port mappings');
                    renderPortMappings(builtInMappings);
                };
                
                xhr.ontimeout = function() {
                    console.warn('Timeout while fetching port mappings, using defaults');
                    renderPortMappings(builtInMappings);
                };
                
                xhr.send();
                
                // If we're using async XHR, return here as renderPortMappings will be called in callbacks
                return;
                
            } catch (error) {
                console.error('Error setting up port mappings fetch:', error);
                // Continue to rendering with default mappings
            }
            
            // This will be called by renderPortMappings for synchronous execution
            // or by the XHR callbacks for asynchronous execution
            renderPortMappings(builtInMappings);
        }
        
        // Function to render port mappings in the table
        function renderPortMappings(builtInMappings) {
            // Get custom mappings from local storage
            let customMappings = {};
            try {
                const storedMappings = localStorage.getItem('customPortMappings');
                if (storedMappings) {
                    customMappings = JSON.parse(storedMappings);
                    // Mark all loaded mappings as custom
                    Object.keys(customMappings).forEach(key => {
                        customMappings[key].custom = true;
                    });
                }
            } catch (error) {
                console.error('Error loading custom mappings:', error);
            }
            
            // Combine built-in and custom mappings
            const allMappings = {...builtInMappings, ...customMappings};
            
            // Clear the loading row
            const tableBody = document.getElementById('port-mappings-body');
            tableBody.innerHTML = '';
            
            // Sort exporters with custom ones first, then alphabetically
            const sortedExporterNames = Object.keys(allMappings).sort((a, b) => {
                const aIsCustom = allMappings[a].custom || false;
                const bIsCustom = allMappings[b].custom || false;
                
                // If one is custom and the other isn't, custom ones come first
                if (aIsCustom && !bIsCustom) return -1;
                if (!aIsCustom && bIsCustom) return 1;
                
                // Otherwise sort alphabetically
                return a.localeCompare(b);
            });
            
            // Populate the table with all mappings
            sortedExporterNames.forEach(exporterName => {
                const mapping = allMappings[exporterName];
                const isCustom = mapping.custom || false;
                
                // Format src ports (to target)
                const toTargetPorts = mapping.src.map(portEntry => {
                    return `${portEntry[0]} ${portEntry[1]}`;
                }).join(', ');
                
                // Format dst ports (from target)
                const fromTargetPorts = mapping.dst.map(portEntry => {
                    return `${portEntry[0]} ${portEntry[1]}`;
                }).join(', ');
                
                // Create a new row
                const row = document.createElement('tr');
                
                // Add cells
                row.innerHTML = `
                    <td>${exporterName}</td>
                    <td>${toTargetPorts || '<em>None</em>'}</td>
                    <td>${fromTargetPorts || '<em>None</em>'}</td>
                    <td>
                        ${isCustom ? 
                            '<span class="custom-badge badge-custom">Custom</span>' : 
                            '<span class="custom-badge badge-config">Config</span>'}
                    </td>
                    <td>
                        ${isCustom ? `<button type="button" class="action-button delete" data-exporter="${exporterName}">Delete</button>` : ''}
                    </td>
                `;
                
                // Add the row to the table
                tableBody.appendChild(row);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.action-button.delete').forEach(button => {
                button.addEventListener('click', function() {
                    const exporterName = this.getAttribute('data-exporter');
                    deleteCustomExporter(exporterName);
                });
            });
        }
        
        // Function to validate and add a new exporter
        function addNewExporter() {
            // Get form values
            const exporterNameInput = document.getElementById('new-exporter-name');
            const toTargetInput = document.getElementById('new-to-target');
            const fromTargetInput = document.getElementById('new-from-target');
            
            const exporterName = exporterNameInput.value.trim();
            const toTarget = toTargetInput.value.trim();
            const fromTarget = fromTargetInput.value.trim();
            
            // Validate inputs
            if (!exporterName) {
                alert('Please enter an exporter name');
                exporterNameInput.focus();
                return;
            }
            
            if (!toTarget) {
                alert('Please enter at least one "To Target" port');
                toTargetInput.focus();
                return;
            }
            
            // Validate exporter name format
            if (!/^[a-zA-Z0-9_-]+$/.test(exporterName)) {
                alert('Exporter name must contain only letters, numbers, underscores, and hyphens');
                exporterNameInput.focus();
                return;
            }
            
            // Validate port formats
            if (!/^[0-9,]+$/.test(toTarget)) {
                alert('To Target ports must be comma-separated numbers');
                toTargetInput.focus();
                return;
            }
            
            if (fromTarget && !/^[0-9,]+$/.test(fromTarget)) {
                alert('From Target ports must be comma-separated numbers');
                fromTargetInput.focus();
                return;
            }
            
            // Get existing custom mappings from local storage
            let customMappings = {};
            try {
                const storedMappings = localStorage.getItem('customPortMappings');
                if (storedMappings) {
                    customMappings = JSON.parse(storedMappings);
                }
            } catch (error) {
                console.error('Error loading custom mappings:', error);
            }
            
            // Check if exporter name already exists
            if (customMappings[exporterName]) {
                if (!confirm(`An exporter named "${exporterName}" already exists. Do you want to replace it?`)) {
                    return;
                }
            }
            
            // Parse to target ports
            const toTargetPorts = toTarget.split(',').map(port => {
                return ['TCP', port.trim()];
            });
            
            // Parse from target ports (if any)
            const fromTargetPorts = fromTarget ? fromTarget.split(',').map(port => {
                return ['TCP', port.trim()];
            }) : [];
            
            // Create the new exporter mapping
            customMappings[exporterName] = {
                src: toTargetPorts,
                dst: fromTargetPorts,
                custom: true
            };
            
            // Save to local storage
            try {
                localStorage.setItem('customPortMappings', JSON.stringify(customMappings));
                
                // Clear form inputs
                exporterNameInput.value = '';
                toTargetInput.value = '';
                fromTargetInput.value = '';
                
                // Get the current built-in mappings
                const xhr = new XMLHttpRequest();
                xhr.open('GET', '/api/port_mappings', false); // Synchronous for simplicity
                xhr.send();
                
                // Reload the port mappings table (either with server data or default mappings)
                if (xhr.status === 200) {
                    const serverMappings = JSON.parse(xhr.responseText);
                    // Convert to client format
                    let currentBuiltInMappings = {};
                    for (const [exporterName, mapping] of Object.entries(serverMappings)) {
                        currentBuiltInMappings[exporterName] = {
                            src: mapping.src.map(entry => Array.isArray(entry) ? entry : [entry[0], entry[1]]),
                            dst: mapping.dst.map(entry => Array.isArray(entry) ? entry : [entry[0], entry[1]]),
                            custom: false
                        };
                    }
                    renderPortMappings(currentBuiltInMappings);
                } else {
                    // If server request fails, reload port mappings which will use defaults
                    loadPortMappings();
                }
                
                // Show success message
                alert(`Exporter "${exporterName}" has been added successfully!`);
            } catch (error) {
                console.error('Error saving custom mappings:', error);
                alert('Error saving exporter: ' + error.message);
            }
        }
        
        // Function to delete a custom exporter
        function deleteCustomExporter(exporterName) {
            if (!confirm(`Are you sure you want to delete the custom exporter "${exporterName}"?`)) {
                return;
            }
            
            // Get existing custom mappings from local storage
            let customMappings = {};
            try {
                const storedMappings = localStorage.getItem('customPortMappings');
                if (storedMappings) {
                    customMappings = JSON.parse(storedMappings);
                }
            } catch (error) {
                console.error('Error loading custom mappings:', error);
            }
            
            // Remove the exporter
            if (customMappings[exporterName]) {
                delete customMappings[exporterName];
                
                // Save back to local storage
                localStorage.setItem('customPortMappings', JSON.stringify(customMappings));
                
                // Reload port mappings
                loadPortMappings();
                
                // Show success message
                alert(`Exporter "${exporterName}" has been deleted.`);
            } else {
                alert(`Exporter "${exporterName}" not found in custom mappings.`);
            }
        }
    </script>
</body>
</html>